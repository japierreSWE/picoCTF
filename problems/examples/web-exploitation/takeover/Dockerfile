FROM php:latest
RUN rm /bin/bash

ARG bash_3_version=4.2
RUN apt-get update
RUN apt-get -y install build-essential curl bison

WORKDIR /tmp
RUN curl -o bash-${bash_3_version}.tar.gz \
  http://ftp.gnu.org/gnu/bash/bash-${bash_3_version}.tar.gz
RUN tar xf bash-${bash_3_version}.tar.gz

WORKDIR /tmp/bash-${bash_3_version}
RUN ./configure
RUN make
RUN make install

USER root
RUN groupadd -r myuser && useradd -r -g myuser myuser
WORKDIR /challenge

COPY html /challenge/html
COPY start.sh /challenge/start.sh
EXPOSE 5555


RUN chmod -R 777 /challenge/html
RUN chmod 700 /challenge/html/webmaster_debug/flag
RUN chmod 700 /challenge/html/webmaster_debug/diagnostics.sh

RUN gcc /challenge/html/webmaster_debug/run_diagnostics.c -o /challenge/html/webmaster_debug/run_diagnostics
RUN chown root /challenge/html/webmaster_debug/run_diagnostics
RUN chmod u+s /challenge/html/webmaster_debug/run_diagnostics
RUN chmod g+s /challenge/html/webmaster_debug/run_diagnostics

RUN apt-get -y update
RUN apt-get install -y policykit-1
RUN apt-get install -y uidmap
RUN apt-get install -y python

CMD sh /challenge/start.sh

USER myuser